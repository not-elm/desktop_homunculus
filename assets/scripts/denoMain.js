var __IIFE__=function(t){"use strict";var e;t.host=void 0,(e=t.host||(t.host={})).base="http://localhost:3100",e.baseUrl=()=>new URL("http://localhost:3100"),e.createUrl=(t,s)=>{const a=new URL(t,e.base);return s&&Object.entries(s).forEach(([t,e])=>{a.searchParams.append(t,String(e))}),a},e.get=async function(t){const e=await fetch(t);return await s(e),e},e.post=async(t,e)=>{const a=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e??{})});return await s(a),a},e.put=async(t,e)=>{const a=await fetch(t,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e??{})});return await s(a),a},e.deleteMethod=async t=>{const e=await fetch(t,{method:"DELETE"});return await s(e),e};const s=async t=>{if(!t.ok)throw new Error(`url: ${t.url}\nStatus ${t.statusText}\n${await t.text()}`)};var a;t.displays=void 0,(t.displays||(t.displays={})).findAll=async()=>{const e=await t.host.get(t.host.createUrl("displays"));return await e.json()},t.effects=void 0,(a=t.effects||(t.effects={})).sound=async e=>{await t.host.post(t.host.createUrl("effects/sounds"),{source:e})},a.stamp=async(e,s)=>{await t.host.post(t.host.createUrl("effects/stamps"),{source:e,...s})};var n,r,i;t.preferences=void 0,(n=t.preferences||(t.preferences={})).load=async e=>{const s=await t.host.get(t.host.createUrl(`preferences/${e}`));return await s.json()},n.save=async(e,s)=>{await t.host.put(t.host.createUrl(`preferences/${e}`),s)},n.loadVrmTransform=async t=>{try{return await n.load(`vrm::${t}::transform`)}catch(t){return{translation:[0,0,0],rotation:[0,0,0,1],scale:[1,1,1]}}},n.saveVrmTransform=async(t,e)=>{await n.save(`vrm::${t}::transform`,e)},t.scripts=void 0,(t.scripts||(t.scripts={})).callJavascript=async e=>{await t.host.post(t.host.createUrl("scripts/js"),{source:e})},t.settings=void 0,(r=t.settings||(t.settings={})).fpsLimit=async()=>{const e=await t.host.get(t.host.createUrl("settings/fps"));return Number(await e.json())},r.saveFpsLimit=async e=>{await t.host.put(t.host.createUrl("settings/fps"),e)},t.shadowPanel=void 0,(i=t.shadowPanel||(t.shadowPanel={})).alpha=async()=>{const e=await t.host.get(t.host.createUrl("shadow-panel/alpha"));return Number(await e.json())},i.setAlpha=async e=>{await t.host.put(t.host.createUrl("shadow-panel/alpha"),{alpha:e})};class o extends Error{constructor(t,e){super(t),this.name="ParseError",this.type=e.type,this.field=e.field,this.value=e.value,this.line=e.line}}function c(t){}function h(t){if("function"==typeof t)throw new TypeError("`callbacks` must be an object, got a function instead. Did you mean `{onEvent: fn}`?");const{onEvent:e=c,onError:s=c,onRetry:a=c,onComment:n}=t;let r,i="",h=!0,l="",d="";function u(t){if(""===t)return l.length>0&&e({id:r,event:d||void 0,data:l.endsWith("\n")?l.slice(0,-1):l}),r=void 0,l="",void(d="");if(t.startsWith(":"))return void(n&&n(t.slice(t.startsWith(": ")?2:1)));const s=t.indexOf(":");if(-1!==s){const e=t.slice(0,s),a=" "===t[s+1]?2:1;return void p(e,t.slice(s+a),t)}p(t,"",t)}function p(t,e,n){switch(t){case"event":d=e;break;case"data":l=`${l}${e}\n`;break;case"id":r=e.includes("\0")?void 0:e;break;case"retry":/^\d+$/.test(e)?a(parseInt(e,10)):s(new o(`Invalid \`retry\` value: "${e}"`,{type:"invalid-retry",value:e,line:n}));break;default:s(new o(`Unknown field "${t.length>20?`${t.slice(0,20)}â€¦`:t}"`,{type:"unknown-field",field:t,value:e,line:n}))}}return{feed:function(t){const e=h?t.replace(/^\xEF\xBB\xBF/,""):t,[s,a]=function(t){const e=[];let s="",a=0;for(;a<t.length;){const n=t.indexOf("\r",a),r=t.indexOf("\n",a);let i=-1;if(-1!==n&&-1!==r?i=Math.min(n,r):-1!==n?i=n:-1!==r&&(i=r),-1===i){s=t.slice(a);break}{const s=t.slice(a,i);e.push(s),a=i+1,"\r"===t[a-1]&&"\n"===t[a]&&a++}}return[e,s]}(`${i}${e}`);for(const t of s)u(t);i=a,h=!1},reset:function(t={}){i&&t.consume&&u(i),h=!0,r=void 0,l="",d="",i=""}}}class l extends Event{constructor(t,e){var s,a;super(t),this.code=null!=(s=null==e?void 0:e.code)?s:void 0,this.message=null!=(a=null==e?void 0:e.message)?a:void 0}[Symbol.for("nodejs.util.inspect.custom")](t,e,s){return s(u(this),e)}[Symbol.for("Deno.customInspect")](t,e){return t(u(this),e)}}function d(t){return t instanceof Error?"errors"in t&&Array.isArray(t.errors)?t.errors.map(d).join(", "):"cause"in t&&t.cause instanceof Error?`${t}: ${d(t.cause)}`:t.message:`${t}`}function u(t){return{type:t.type,message:t.message,code:t.code,defaultPrevented:t.defaultPrevented,cancelable:t.cancelable,timeStamp:t.timeStamp}}var p,w,v,m,y,f,g,E,b,U,S,N,k,$,T,C,j,M,W,x,O,L,I,P=t=>{throw TypeError(t)},A=(t,e,s)=>e.has(t)||P("Cannot "+s),R=(t,e,s)=>(A(t,e,"read from private field"),s?s.call(t):e.get(t)),D=(t,e,s)=>e.has(t)?P("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),V=(t,e,s,a)=>(A(t,e,"write to private field"),e.set(t,s),s),_=(t,e,s)=>(A(t,e,"access private method"),s);let B=class extends EventTarget{constructor(t,e){var s,a;super(),D(this,$),this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,D(this,p),D(this,w),D(this,v),D(this,m),D(this,y),D(this,f),D(this,g),D(this,E,null),D(this,b),D(this,U),D(this,S,null),D(this,N,null),D(this,k,null),D(this,C,async t=>{var e;R(this,U).reset();const{body:s,redirected:a,status:n,headers:r}=t;if(204===n)return _(this,$,O).call(this,"Server sent HTTP 204, not reconnecting",204),void this.close();if(V(this,v,a?new URL(t.url):void 0),200!==n)return void _(this,$,O).call(this,`Non-200 status code (${n})`,n);if(!(r.get("content-type")||"").startsWith("text/event-stream"))return void _(this,$,O).call(this,'Invalid content type, expected "text/event-stream"',n);if(R(this,p)===this.CLOSED)return;V(this,p,this.OPEN);const i=new Event("open");if(null==(e=R(this,k))||e.call(this,i),this.dispatchEvent(i),"object"!=typeof s||!s||!("getReader"in s))return _(this,$,O).call(this,"Invalid response body, expected a web ReadableStream",n),void this.close();const o=new TextDecoder,c=s.getReader();let h=!0;do{const{done:t,value:e}=await c.read();e&&R(this,U).feed(o.decode(e,{stream:!t})),t&&(h=!1,R(this,U).reset(),_(this,$,L).call(this))}while(h)}),D(this,j,t=>{V(this,b,void 0),"AbortError"!==t.name&&"aborted"!==t.type&&_(this,$,L).call(this,d(t))}),D(this,W,t=>{"string"==typeof t.id&&V(this,E,t.id);const e=new MessageEvent(t.event||"message",{data:t.data,origin:R(this,v)?R(this,v).origin:R(this,w).origin,lastEventId:t.id||""});R(this,N)&&(!t.event||"message"===t.event)&&R(this,N).call(this,e),this.dispatchEvent(e)}),D(this,x,t=>{V(this,f,t)}),D(this,I,()=>{V(this,g,void 0),R(this,p)===this.CONNECTING&&_(this,$,T).call(this)});try{if(t instanceof URL)V(this,w,t);else{if("string"!=typeof t)throw new Error("Invalid URL");V(this,w,new URL(t,function(){const t="document"in globalThis?globalThis.document:void 0;return t&&"object"==typeof t&&"baseURI"in t&&"string"==typeof t.baseURI?t.baseURI:void 0}()))}}catch{throw function(t){const e=globalThis.DOMException;return"function"==typeof e?new e(t,"SyntaxError"):new SyntaxError(t)}("An invalid or illegal string was specified")}V(this,U,h({onEvent:R(this,W),onRetry:R(this,x)})),V(this,p,this.CONNECTING),V(this,f,3e3),V(this,y,null!=(s=null==e?void 0:e.fetch)?s:globalThis.fetch),V(this,m,null!=(a=null==e?void 0:e.withCredentials)&&a),_(this,$,T).call(this)}get readyState(){return R(this,p)}get url(){return R(this,w).href}get withCredentials(){return R(this,m)}get onerror(){return R(this,S)}set onerror(t){V(this,S,t)}get onmessage(){return R(this,N)}set onmessage(t){V(this,N,t)}get onopen(){return R(this,k)}set onopen(t){V(this,k,t)}addEventListener(t,e,s){const a=e;super.addEventListener(t,a,s)}removeEventListener(t,e,s){const a=e;super.removeEventListener(t,a,s)}close(){R(this,g)&&clearTimeout(R(this,g)),R(this,p)!==this.CLOSED&&(R(this,b)&&R(this,b).abort(),V(this,p,this.CLOSED),V(this,b,void 0))}};var F,G,J,Y;p=new WeakMap,w=new WeakMap,v=new WeakMap,m=new WeakMap,y=new WeakMap,f=new WeakMap,g=new WeakMap,E=new WeakMap,b=new WeakMap,U=new WeakMap,S=new WeakMap,N=new WeakMap,k=new WeakMap,$=new WeakSet,T=function(){V(this,p,this.CONNECTING),V(this,b,new AbortController),R(this,y)(R(this,w),_(this,$,M).call(this)).then(R(this,C)).catch(R(this,j))},C=new WeakMap,j=new WeakMap,M=function(){var t;const e={mode:"cors",redirect:"follow",headers:{Accept:"text/event-stream",...R(this,E)?{"Last-Event-ID":R(this,E)}:void 0},cache:"no-store",signal:null==(t=R(this,b))?void 0:t.signal};return"window"in globalThis&&(e.credentials=this.withCredentials?"include":"same-origin"),e},W=new WeakMap,x=new WeakMap,O=function(t,e){var s;R(this,p)!==this.CLOSED&&V(this,p,this.CLOSED);const a=new l("error",{code:e,message:t});null==(s=R(this,S))||s.call(this,a),this.dispatchEvent(a)},L=function(t,e){var s;if(R(this,p)===this.CLOSED)return;V(this,p,this.CONNECTING);const a=new l("error",{code:e,message:t});null==(s=R(this,S))||s.call(this,a),this.dispatchEvent(a),V(this,g,setTimeout(R(this,I),R(this,f)))},I=new WeakMap,B.CONNECTING=0,B.OPEN=1,B.CLOSED=2,t.entities=void 0,(F=t.entities||(t.entities={})).transform=async e=>{const s=await t.host.get(t.host.createUrl(`entities/${e}/transform`));return await s.json()},F.setTransform=async(e,s)=>{await t.host.put(t.host.createUrl(`entities/${e}/transform`),s)},F.name=async e=>{const s=await t.host.get(t.host.createUrl(`entities/${e}/name`));return await s.json()},F.findByName=async(e,s)=>{const a=await t.host.get(t.host.createUrl("entities/find",{name:e,root:s?.root}));return await a.json()};class H{args;constructor(t){this.args=t}static forever(){return new H({type:"forever"})}static count(t){return new H({type:"count",count:t})}static never(){return new H({type:"never"})}}class q{entity;constructor(t){this.entity=t}async play(e){await t.host.put(t.host.createUrl(`vrma/${this.entity}/play`),{repeat:e?.repeat?.args,transitionSecs:e?.transitionSecs,waitForCompletion:e?.waitForCompletion})}async stop(){await t.host.put(t.host.createUrl(`vrma/${this.entity}/stop`))}}class z{eventSource;constructor(t){this.eventSource=t}on(t,e){this.eventSource.addEventListener(t,t=>{e(JSON.parse(t.data))})}close(){this.eventSource.close()}[Symbol.dispose](){this.eventSource.close()}}class K{entity;constructor(t){this.entity=t}events(){const e=t.host.createUrl(`vrm/${this.entity}/events`);return new z(new B(e))}async state(){const t=await this.fetch("state");return(await t.json()).state}async setState(t){await this.put("state",{state:t})}async name(){return await t.entities.name(this.entity)}async findBoneEntity(e){return await t.entities.findByName(e,{root:this.entity})}async vrma(e){const s=await t.host.get(t.host.createUrl(`vrm/${this.entity}/vrma`,{source:e})),a=Number(await s.json());return new q(a)}async speakOnVoiceVox(t,e){return(await this.post("speech/voicevox",{sentences:"string"==typeof t?[t]:t,...e})).body.pipeThrough(new TextDecoderStream)}async lookAtCursor(){await this.put("look/cursor")}async lookAtTarget(t){await this.put(`look/target/${t}`)}async unlook(){await this.delete("look")}static async spawn(e,s){const a=await t.host.post(t.host.createUrl("vrm"),{asset:e,...s});return new K(Number(await a.text()))}static async findByName(e){return new K(Number(await t.entities.findByName(e)))}static async waitLoadByName(e){const s=await t.host.get(t.host.createUrl("vrm/wait-load",{name:e}));return new K(Number(await s.json()))}static async findAllMetadata(){const e=await t.host.get(t.host.createUrl("vrm/all"));return await e.json()}static streamAllMetadata(e){const s=new B(t.host.createUrl("vrm/all?stream=true"));return s.addEventListener("message",t=>{e(JSON.parse(t.data))}),s}static streamAll(t){return K.streamAllMetadata(e=>{t(new K(e.entity))})}static async findAll(){return(await K.findAllMetadata()).map(t=>new K(t.entity))}static caller(){const t=window.CALLER_VRM_ENTITY;return void 0!==t?new K(t):void 0}async fetch(e){return await t.host.get(t.host.createUrl(`vrm/${this.entity}/${e}`))}async post(e,s){return await t.host.post(t.host.createUrl(`vrm/${this.entity}/${e}`),s)}async put(e,s){await t.host.put(t.host.createUrl(`vrm/${this.entity}/${e}`),s)}async delete(e){await t.host.deleteMethod(t.host.createUrl(`vrm/${this.entity}/${e}`))}}class Q{entity;constructor(t){this.entity=t,this.entity=t}async close(){await t.host.post(t.host.createUrl(`webviews/${this.entity}/close`))}async isClosed(){const e=await t.host.get(t.host.createUrl(`webviews/${this.entity}/is-closed`));return await e.json()}static async open(e){const s=await t.host.post(t.host.createUrl("webviews"),e);return new Q(Number(await s.json()))}static current(){const t=window.WEBVIEW_ENTITY;return void 0!==t?new Q(t):void 0}}return t.mods=void 0,(t.mods||(t.mods={})).menus=async()=>{const e=await t.host.get(t.host.createUrl("mods/menus"));return await e.json()},t.gpt=void 0,(G=t.gpt||(t.gpt={})).availableModels=async()=>{const e=await t.host.get(t.host.createUrl("gpt/available-models"));return await e.json()},G.model=async e=>{const s=await t.host.get(t.host.createUrl("gpt/model",e));return await s.json()},G.saveModel=async(e,s)=>{await t.host.put(t.host.createUrl("gpt/model"),{model:e,...s})},G.useWebSearch=async e=>{const s=await t.host.get(t.host.createUrl("gpt/use-web-search",e));return await s.json()},G.saveUseWebSearch=async(e,s)=>{await t.host.put(t.host.createUrl("gpt/use-web-search"),{useWebSearch:e,...s})},G.systemPrompt=async e=>{const s=await t.host.get(t.host.createUrl("gpt/system-prompt",e));return await s.json()},G.saveSystemPrompt=async(e,s)=>{await t.host.put(t.host.createUrl("gpt/system-prompt"),{systemPrompt:e,...s})},G.chat=async(e,s)=>{const a=await t.host.post(t.host.createUrl("gpt/chat"),{userMessage:e,options:s});return await a.json()},G.voicevoxSpeaker=async e=>{const s=await t.host.get(t.host.createUrl("gpt/speaker/voicevox",e));return await s.json()},G.saveVoicevoxSpeaker=async(e,s)=>{await t.host.put(t.host.createUrl("gpt/speaker/voicevox"),{id:e,...s})},t.commands=void 0,(J=t.commands||(t.commands={})).stream=(e,s)=>{const a=t.host.createUrl(`commands/${e}`),n=new EventSource(a);return n.addEventListener("message",async t=>{try{const e=JSON.parse(t.data);await s(e)}catch(t){console.error(`Error processing command ${e}:`,t)}}),n},J.send=async(e,s)=>{await t.host.post(t.host.createUrl(`commands/${e}`),s)},t.cameras=void 0,(Y=t.cameras||(t.cameras={})).globalViewportToWorld2d=async e=>{const s=t.host.createUrl("cameras/world-2d",e),a=await t.host.get(s);return await a.json()},Y.worldToGlobalViewport=async e=>{const s=t.host.createUrl("cameras/global-view-port",e),a=await t.host.get(s);return await a.json()},t.app=void 0,(t.app||(t.app={})).exit=async()=>{await t.host.post(t.host.createUrl("app/exit"))},t.Repeat=H,t.Vrm=K,t.VrmEventSource=z,t.Vrma=q,t.Webview=Q,t.runtime=()=>"undefined"!=typeof window&&void 0!==window.EventSource?"browser":"undefined"!=typeof process&&process.versions?.node?"nodejs":"deno",t.sleep=t=>new Promise(e=>setTimeout(e,t)),t}({});Object.defineProperty(Deno,"api",{value:__IIFE__});
